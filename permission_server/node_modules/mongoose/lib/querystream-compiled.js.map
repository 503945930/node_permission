{"version":3,"sources":["querystream.js"],"names":[],"mappings":"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","file":"querystream-compiled.js","sourcesContent":["\n/*!\n * Module dependencies.\n */\n\nvar Stream = require('stream').Stream\nvar utils = require('./utils')\nvar helpers = require('./queryhelpers')\nvar K = function(k){ return k }\n\n/**\n * Provides a Node.js 0.8 style [ReadStream](http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream) interface for Queries.\n *\n *     var stream = Model.find().stream();\n *\n *     stream.on('data', function (doc) {\n *       // do something with the mongoose document\n *     }).on('error', function (err) {\n *       // handle the error\n *     }).on('close', function () {\n *       // the stream is closed\n *     });\n *\n *\n * The stream interface allows us to simply \"plug-in\" to other _Node.js 0.8_ style write streams.\n *\n *     Model.where('created').gte(twoWeeksAgo).stream().pipe(writeStream);\n *\n * ####Valid options\n *\n *   - `transform`: optional function which accepts a mongoose document. The return value of the function will be emitted on `data`.\n *\n * ####Example\n *\n *     // JSON.stringify all documents before emitting\n *     var stream = Thing.find().stream({ transform: JSON.stringify });\n *     stream.pipe(writeStream);\n *\n * _NOTE: plugging into an HTTP response will *not* work out of the box. Those streams expect only strings or buffers to be emitted, so first formatting our documents as strings/buffers is necessary._\n *\n * _NOTE: these streams are Node.js 0.8 style read streams which differ from Node.js 0.10 style. Node.js 0.10 streams are not well tested yet and are not guaranteed to work._\n *\n * @param {Query} query\n * @param {Object} [options]\n * @inherits NodeJS Stream http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream\n * @event `data`: emits a single Mongoose document\n * @event `error`: emits when an error occurs during streaming. This will emit _before_ the `close` event.\n * @event `close`: emits when the stream reaches the end of the cursor or an error occurs, or the stream is manually `destroy`ed. After this event, no more events are emitted.\n * @api public\n */\n\nfunction QueryStream (query, options) {\n  Stream.call(this);\n\n  this.query = query;\n  this.readable = true;\n  this.paused = false;\n  this._cursor = null;\n  this._destroyed = null;\n  this._fields = null;\n  this._buffer = null;\n  this._inline = T_INIT;\n  this._running = false;\n  this._transform = options && 'function' == typeof options.transform\n    ? options.transform\n    : K;\n\n  // give time to hook up events\n  var self = this;\n  process.nextTick(function () {\n    self._init();\n  });\n}\n\n/*!\n * Inherit from Stream\n */\n\nQueryStream.prototype.__proto__ = Stream.prototype;\n\n/**\n * Flag stating whether or not this stream is readable.\n *\n * @property readable\n * @api public\n */\n\nQueryStream.prototype.readable;\n\n/**\n * Flag stating whether or not this stream is paused.\n *\n * @property paused\n * @api public\n */\n\nQueryStream.prototype.paused;\n\n// trampoline flags\nvar T_INIT = 0;\nvar T_IDLE = 1;\nvar T_CONT = 2;\n\n/**\n * Initializes the query.\n *\n * @api private\n */\n\nQueryStream.prototype._init = function () {\n  if (this._destroyed) return;\n\n  var query = this.query\n    , model = query.model\n    , options = query._optionsForExec(model)\n    , self = this\n\n  try {\n    query.cast(model);\n  } catch (err) {\n    return self.destroy(err);\n  }\n\n  self._fields = utils.clone(query._fields);\n  options.fields = query._castFields(self._fields);\n\n  model.collection.find(query._conditions, options, function (err, cursor) {\n    if (err) return self.destroy(err);\n    self._cursor = cursor;\n    self._next();\n  });\n}\n\n/**\n * Trampoline for pulling the next doc from cursor.\n *\n * @see QueryStream#__next #querystream_QueryStream-__next\n * @api private\n */\n\nQueryStream.prototype._next = function _next () {\n  if (this.paused || this._destroyed) {\n    return this._running = false;\n  }\n\n  this._running = true;\n\n  if (this._buffer && this._buffer.length) {\n    var arg;\n    while (!this.paused && !this._destroyed && (arg = this._buffer.shift())) {\n      this._onNextObject.apply(this, arg);\n    }\n  }\n\n  // avoid stack overflows with large result sets.\n  // trampoline instead of recursion.\n  while (this.__next()) {}\n}\n\n/**\n * Pulls the next doc from the cursor.\n *\n * @see QueryStream#_next #querystream_QueryStream-_next\n * @api private\n */\n\nQueryStream.prototype.__next = function () {\n  if (this.paused || this._destroyed)\n    return this._running = false;\n\n  var self = this;\n  self._inline = T_INIT;\n\n  self._cursor.nextObject(function cursorcb (err, doc) {\n    self._onNextObject(err, doc);\n  });\n\n  // if onNextObject() was already called in this tick\n  // return ourselves to the trampoline.\n  if (T_CONT === this._inline) {\n    return true;\n  } else {\n    // onNextObject() hasn't fired yet. tell onNextObject\n    // that its ok to call _next b/c we are not within\n    // the trampoline anymore.\n    this._inline = T_IDLE;\n  }\n}\n\n/**\n * Transforms raw `doc`s returned from the cursor into a model instance.\n *\n * @param {Error|null} err\n * @param {Object} doc\n * @api private\n */\n\nQueryStream.prototype._onNextObject = function _onNextObject (err, doc) {\n  if (this._destroyed) return;\n\n  if (this.paused) {\n    this._buffer || (this._buffer = []);\n    this._buffer.push([err, doc]);\n    return this._running = false;\n  }\n\n  if (err) return this.destroy(err);\n\n  // when doc is null we hit the end of the cursor\n  if (!doc) {\n    this.emit('end');\n    return this.destroy();\n  }\n\n  var opts = this.query._mongooseOptions;\n\n  if (!opts.populate) {\n    return true === opts.lean ?\n      emit(this, doc) :\n      createAndEmit(this, null, doc);\n  }\n\n  var self = this;\n  var pop = helpers.preparePopulationOptionsMQ(self.query, self.query._mongooseOptions);\n\n  self.query.model.populate(doc, pop, function (err, doc) {\n    if (err) return self.destroy(err);\n    return true === opts.lean ?\n      emit(self, doc) :\n      createAndEmit(self, pop, doc);\n  });\n}\n\nfunction createAndEmit (self, populatedIds, doc) {\n  var instance = helpers.createModel(self.query.model, doc, self._fields);\n  var opts = populatedIds ?\n    { populated: populatedIds } :\n    undefined;\n\n  instance.init(doc, opts, function (err) {\n    if (err) return self.destroy(err);\n    emit(self, instance);\n  });\n}\n\n/*!\n * Emit a data event and manage the trampoline state\n */\n\nfunction emit (self, doc) {\n  self.emit('data', self._transform(doc));\n\n  // trampoline management\n  if (T_IDLE === self._inline) {\n    // no longer in trampoline. restart it.\n    self._next();\n  } else {\n    // in a trampoline. tell __next that its\n    // ok to continue jumping.\n    self._inline = T_CONT;\n  }\n}\n\n/**\n * Pauses this stream.\n *\n * @api public\n */\n\nQueryStream.prototype.pause = function () {\n  this.paused = true;\n}\n\n/**\n * Resumes this stream.\n *\n * @api public\n */\n\nQueryStream.prototype.resume = function () {\n  this.paused = false;\n\n  if (!this._cursor) {\n    // cannot start if not initialized\n    return;\n  }\n\n  // are we within the trampoline?\n  if (T_INIT === this._inline) {\n    return;\n  }\n\n  if (!this._running) {\n    // outside QueryStream control, need manual restart\n    return this._next();\n  }\n}\n\n/**\n * Destroys the stream, closing the underlying cursor. No more events will be emitted.\n *\n * @param {Error} [err]\n * @api public\n */\n\nQueryStream.prototype.destroy = function (err) {\n  if (this._destroyed) return;\n  this._destroyed = true;\n  this._running = false;\n  this.readable = false;\n\n  if (this._cursor) {\n    this._cursor.close();\n  }\n\n  if (err) {\n    this.emit('error', err);\n  }\n\n  this.emit('close');\n}\n\n/**\n * Pipes this query stream into another stream. This method is inherited from NodeJS Streams.\n *\n * ####Example:\n *\n *     query.stream().pipe(writeStream [, options])\n *\n * @method pipe\n * @memberOf QueryStream\n * @see NodeJS http://nodejs.org/api/stream.html\n * @api public\n */\n\n/*!\n * Module exports\n */\n\nmodule.exports = exports = QueryStream;\n"]}