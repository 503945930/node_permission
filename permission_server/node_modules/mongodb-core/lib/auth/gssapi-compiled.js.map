{"version":3,"sources":["gssapi.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;AAEb,IAAI,CAAC,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM;IAC1B,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC;IAC1B,UAAU,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;;AAErC,IAAI,WAAW,GAAG,SAAd,WAAW,CAAY,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,OAAO,EAAE;AAC1D,MAAI,CAAC,EAAE,GAAG,EAAE,CAAC;AACb,MAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;AACzB,MAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;AACzB,MAAI,CAAC,OAAO,GAAG,OAAO,CAAC;CACxB,CAAA;;AAED,WAAW,CAAC,SAAS,CAAC,KAAK,GAAG,UAAS,OAAO,EAAE;AAC9C,SAAO,OAAO,CAAC,EAAE,IAAI,IAAI,CAAC,EAAE,IACvB,OAAO,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,IACjC,OAAO,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,CAAC;CACxC,CAAA;;;AAGD,IAAI,QAAQ,GAAG,IAAI,CAAC;AACpB,IAAI,gBAAgB,GAAG,IAAI,CAAC;;;AAG5B,IAAI;AACF,UAAQ,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC,QAAQ,CAAA;;AAEvC,kBAAgB,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC,SAAS,CAAC,gBAAgB,CAAA;CAClE,CAAC,OAAM,GAAG,EAAE,EAAE;;;;;;;AAOf,IAAI,MAAM,GAAG,SAAT,MAAM,GAAc;AACtB,MAAI,CAAC,SAAS,GAAG,EAAE,CAAC;CACrB,CAAA;;;;;;;;;;;;;AAaD,MAAM,CAAC,SAAS,CAAC,IAAI,GAAG,UAAS,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE;AACxF,MAAI,IAAI,GAAG,IAAI,CAAC;;AAEhB,MAAG,QAAQ,IAAI,IAAI,EAAE,OAAO,QAAQ,CAAC,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC,CAAC;AACrF,MAAI,iBAAiB,GAAG,OAAO,CAAC,mBAAmB,CAAC,IAAI,SAAS,CAAC;;AAElE,MAAI,WAAW,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;;AAEhC,MAAI,KAAK,GAAG,WAAW,CAAC,MAAM,CAAC;AAC/B,MAAG,KAAK,IAAI,CAAC,EAAE,OAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;;;AAG3C,MAAI,wBAAwB,GAAG,CAAC,CAAC;AACjC,MAAI,gBAAgB,GAAG,KAAK,CAAC;AAC7B,MAAI,WAAW,GAAG,IAAI,CAAC;;;AAGvB,SAAM,WAAW,CAAC,MAAM,GAAG,CAAC,EAAE;;AAE5B,QAAI,OAAO,GAAG,SAAV,OAAO,CAAY,UAAU,EAAE;;AAEjC,sBAAgB,CAAC,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,EAAE,EAAE,iBAAiB,EAAE,MAAM,EAAE,UAAU,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;;AAEnG,aAAK,GAAG,KAAK,GAAG,CAAC,CAAC;;;AAGlB,YAAG,GAAG,EAAE;AACN,qBAAW,GAAG,GAAG,CAAC;SACnB,MAAM,IAAG,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE;AAC1B,qBAAW,GAAG,CAAC,CAAC,MAAM,CAAC;SACxB,MAAM,IAAG,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE;AAC5B,qBAAW,GAAG,CAAC,CAAC,MAAM,CAAC;SACxB,MAAM;AACL,0BAAgB,GAAG,IAAI,CAAC;AACxB,kCAAwB,GAAG,wBAAwB,GAAG,CAAC,CAAC;SACzD;;;AAGD,YAAG,KAAK,IAAI,CAAC,IAAI,wBAAwB,GAAG,CAAC,EAAE;;AAE7C,wBAAc,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,WAAW,CAAC,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC,CAAC;;AAEjF,kBAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;SACtB,MAAM,IAAG,KAAK,IAAI,CAAC,EAAE;AACpB,cAAG,WAAW,IAAI,IAAI,EAAE,WAAW,GAAG,IAAI,UAAU,CAAC,CAAC,CAAC,sCAAsC,CAAC,CAAC,CAAC;AAChG,kBAAQ,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;SAC9B;OACF,CAAC,CAAC;KACJ,CAAA;;;AAGD,WAAO,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC,CAAC;GAC9B;CACF,CAAA;;;;AAID,IAAI,gBAAgB,GAAG,SAAnB,gBAAgB,CAAY,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAE,iBAAiB,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE;;AAE/G,MAAI,kBAAkB,GAAG,IAAI,gBAAgB,CAAC,UAAU,CAAC,IAAI,EAAE,UAAU,CAAC,IAAI,EAAE,iBAAiB,CAAC,CAAC;;;AAGnG,oBAAkB,CAAC,IAAI,CAAC,QAAQ,EAAE,QAAQ,EAAE,UAAS,GAAG,EAAE,OAAO,EAAE;AACjE,QAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;;;AAGpC,sBAAkB,CAAC,UAAU,CAAC,EAAE,EAAE,UAAS,GAAG,EAAE,OAAO,EAAE;AACvD,UAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;;;AAGpC,4BAAsB,CAAC,kBAAkB,EAAE,OAAO,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,CAAC,CAAC;KACnH,CAAC,CAAC;GACJ,CAAC,CAAC;CACJ,CAAA;;;;AAID,IAAI,sBAAsB,GAAG,SAAzB,sBAAsB,CAAY,kBAAkB,EAAE,OAAO,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE;;AAE/H,MAAI,OAAO,GAAG;AACV,aAAS,EAAE,CAAC;AACZ,aAAS,EAAE,QAAQ;AACnB,WAAO,EAAE,OAAO;AAChB,iBAAa,EAAE,CAAC;GACnB,CAAC;;;AAGF,QAAM,CAAC,OAAO,CAAC,gBAAgB,EAC3B,OAAO,EACP,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;AAC/C,QAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;AACpC,QAAI,GAAG,GAAG,CAAC,CAAC,MAAM,CAAC;;AAEnB,sBAAkB,CAAC,UAAU,CAAC,CAAC,CAAC,MAAM,CAAC,OAAO,EAAE,UAAS,GAAG,EAAE,OAAO,EAAE;AACrE,UAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;;;AAGpC,6BAAuB,CAAC,kBAAkB,EAAE,OAAO,EAAE,GAAG,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,CAAC,CAAC;KACzH,CAAC,CAAC;GACJ,CAAC,CAAC;CACJ,CAAA;;;;AAID,IAAI,uBAAuB,GAAG,SAA1B,uBAAuB,CAAY,kBAAkB,EAAE,OAAO,EAAE,GAAG,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE;;AAErI,MAAI,OAAO,GAAG;AACV,gBAAY,EAAE,CAAC;AACf,kBAAc,EAAE,GAAG,CAAC,cAAc;AAClC,WAAO,EAAE,OAAO;GACnB,CAAC;;;AAGF,QAAM,CAAC,OAAO,CAAC,gBAAgB,EAC3B,OAAO,EACP,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;AAC/C,QAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;AACpC,QAAI,GAAG,GAAG,CAAC,CAAC,MAAM,CAAC;;AAEnB,sBAAkB,CAAC,UAAU,CAAC,GAAG,CAAC,OAAO,EAAE,UAAS,GAAG,EAAE,OAAO,EAAE;AAChE,UAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;;;AAGpC,4BAAsB,CAAC,kBAAkB,EAAE,OAAO,EAAE,GAAG,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,CAAC,CAAC;KACxH,CAAC,CAAC;GACJ,CAAC,CAAC;CACJ,CAAA;;AAED,IAAI,sBAAsB,GAAG,SAAzB,sBAAsB,CAAY,kBAAkB,EAAE,OAAO,EAAE,GAAG,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE;;AAEpI,MAAI,OAAO,GAAG;AACV,gBAAY,EAAE,CAAC;AACf,kBAAc,EAAE,GAAG,CAAC,cAAc;AAClC,WAAO,EAAE,OAAO;GACnB,CAAC;;;AAGF,QAAM,CAAC,OAAO,CAAC,gBAAgB,EAC3B,OAAO,EACP,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;AAC/C,QAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;AACpC,sBAAkB,CAAC,UAAU,CAAC,IAAI,EAAE,UAAS,GAAG,EAAE,OAAO,EAAE;AACzD,UAAG,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;AACnC,cAAQ,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;KACnB,CAAC,CAAC;GACJ,CAAC,CAAC;CACJ,CAAA;;;AAGD,IAAI,cAAc,GAAG,SAAjB,cAAc,CAAY,SAAS,EAAE,OAAO,EAAE;AAChD,MAAI,KAAK,GAAG,KAAK,CAAC;;AAElB,OAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACxC,QAAG,SAAS,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE;AAC9B,WAAK,GAAG,IAAI,CAAC;AACb,YAAM;KACP;GACF;;AAED,MAAG,CAAC,KAAK,EAAE,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;CACpC,CAAA;;;;;;;;;;AAUD,MAAM,CAAC,SAAS,CAAC,cAAc,GAAG,UAAS,MAAM,EAAE,IAAI,EAAE,QAAQ,EAAE;AACjE,MAAI,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;AAClC,MAAG,KAAK,IAAI,CAAC,EAAE,OAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;;AAE3C,OAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AAC7C,QAAI,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,OAAO,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;AAChJ,WAAK,GAAG,KAAK,GAAG,CAAC,CAAC;;AAElB,UAAG,KAAK,IAAI,CAAC,EAAE;AACb,gBAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;OACtB;KACF,CAAC,CAAC;GACJ;CACF,CAAA;;;;;;;;;;AAUD,MAAM,CAAC,OAAO,GAAG,MAAM,CAAC","file":"gssapi-compiled.js","sourcesContent":["\"use strict\";\n\nvar f = require('util').format\n  , crypto = require('crypto')\n  , MongoError = require('../error');\n\nvar AuthSession = function(db, username, password, options) {\n  this.db = db;\n  this.username = username;\n  this.password = password;\n  this.options = options;\n}\n\nAuthSession.prototype.equal = function(session) {\n  return session.db == this.db \n    && session.username == this.username\n    && session.password == this.password;\n}\n\n// Kerberos class\nvar Kerberos = null;\nvar MongoAuthProcess = null;\n\n// Try to grab the Kerberos class\ntry {\n  Kerberos = require('kerberos').Kerberos\n  // Authentication process for Mongo\n  MongoAuthProcess = require('kerberos').processes.MongoAuthProcess\n} catch(err) {}\n\n/**\n * Creates a new GSSAPI authentication mechanism\n * @class\n * @return {GSSAPI} A cursor instance\n */\nvar GSSAPI = function() {\n  this.authStore = [];\n}\n\n/**\n * Authenticate\n * @method\n * @param {{Server}|{ReplSet}|{Mongos}} server Topology the authentication method is being called on\n * @param {Pool} pool Connection pool for this topology\n * @param {string} db Name of the database\n * @param {string} username Username\n * @param {string} password Password\n * @param {authResultCallback} callback The callback to return the result from the authentication\n * @return {object}\n */\nGSSAPI.prototype.auth = function(server, pool, db, username, password, options, callback) {\n  var self = this;\n  // We don't have the Kerberos library\n  if(Kerberos == null) return callback(new Error(\"Kerberos library is not installed\"));  \n  var gssapiServiceName = options['gssapiServiceName'] || 'mongodb';\n  // Get all the connections\n  var connections = pool.getAll();\n  // Total connections\n  var count = connections.length;\n  if(count == 0) return callback(null, null);\n\n  // Valid connections\n  var numberOfValidConnections = 0;\n  var credentialsValid = false;\n  var errorObject = null;\n\n  // For each connection we need to authenticate\n  while(connections.length > 0) {    \n    // Execute MongoCR\n    var execute = function(connection) {\n      // Start Auth process for a connection\n      GSSAPIInitialize(db, username, password, db, gssapiServiceName, server, connection, function(err, r) {\n        // Adjust count\n        count = count - 1;\n\n        // If we have an error\n        if(err) {\n          errorObject = err;\n        } else if(r.result['$err']) {\n          errorObject = r.result;\n        } else if(r.result['errmsg']) {\n          errorObject = r.result;\n        } else {\n          credentialsValid = true;\n          numberOfValidConnections = numberOfValidConnections + 1;\n        }\n\n        // We have authenticated all connections\n        if(count == 0 && numberOfValidConnections > 0) {\n          // Store the auth details\n          addAuthSession(self.authStore, new AuthSession(db, username, password, options));\n          // Return correct authentication\n          callback(null, true);\n        } else if(count == 0) {\n          if(errorObject == null) errorObject = new MongoError(f(\"failed to authenticate using mongocr\"));\n          callback(errorObject, false);\n        }\n      });\n    }\n\n    // Get the connection\n    execute(connections.shift());\n  }\n}\n\n//\n// Initialize step\nvar GSSAPIInitialize = function(db, username, password, authdb, gssapiServiceName, server, connection, callback) {\n  // Create authenticator\n  var mongo_auth_process = new MongoAuthProcess(connection.host, connection.port, gssapiServiceName);\n\n  // Perform initialization\n  mongo_auth_process.init(username, password, function(err, context) {\n    if(err) return callback(err, false);\n\n    // Perform the first step\n    mongo_auth_process.transition('', function(err, payload) {\n      if(err) return callback(err, false);\n\n      // Call the next db step\n      MongoDBGSSAPIFirstStep(mongo_auth_process, payload, db, username, password, authdb, server, connection, callback);\n    });\n  });\n}\n\n//\n// Perform first step against mongodb\nvar MongoDBGSSAPIFirstStep = function(mongo_auth_process, payload, db, username, password, authdb, server, connection, callback) {\n  // Build the sasl start command\n  var command = {\n      saslStart: 1\n    , mechanism: 'GSSAPI'\n    , payload: payload\n    , autoAuthorize: 1\n  };\n\n  // Execute first sasl step\n  server.command(\"$external.$cmd\"\n    , command\n    , { connection: connection }, function(err, r) {\n    if(err) return callback(err, false);    \n    var doc = r.result;\n    // Execute mongodb transition\n    mongo_auth_process.transition(r.result.payload, function(err, payload) {\n      if(err) return callback(err, false);\n\n      // MongoDB API Second Step\n      MongoDBGSSAPISecondStep(mongo_auth_process, payload, doc, db, username, password, authdb, server, connection, callback);\n    });\n  });\n}\n\n//\n// Perform first step against mongodb\nvar MongoDBGSSAPISecondStep = function(mongo_auth_process, payload, doc, db, username, password, authdb, server, connection, callback) {\n  // Build Authentication command to send to MongoDB\n  var command = {\n      saslContinue: 1\n    , conversationId: doc.conversationId\n    , payload: payload\n  };\n\n  // Execute the command\n  server.command(\"$external.$cmd\"\n    , command\n    , { connection: connection }, function(err, r) {\n    if(err) return callback(err, false);\n    var doc = r.result;\n    // Call next transition for kerberos\n    mongo_auth_process.transition(doc.payload, function(err, payload) {\n      if(err) return callback(err, false);\n\n      // Call the last and third step\n      MongoDBGSSAPIThirdStep(mongo_auth_process, payload, doc, db, username, password, authdb, server, connection, callback);\n    });    \n  });\n}\n\nvar MongoDBGSSAPIThirdStep = function(mongo_auth_process, payload, doc, db, username, password, authdb, server, connection, callback) {\n  // Build final command\n  var command = {\n      saslContinue: 1\n    , conversationId: doc.conversationId\n    , payload: payload\n  };\n\n  // Execute the command\n  server.command(\"$external.$cmd\"\n    , command\n    , { connection: connection }, function(err, r) {\n    if(err) return callback(err, false);\n    mongo_auth_process.transition(null, function(err, payload) {\n      if(err) return callback(err, null);\n      callback(null, r);\n    });\n  });\n}\n\n// Add to store only if it does not exist\nvar addAuthSession = function(authStore, session) {\n  var found = false;\n\n  for(var i = 0; i < authStore.length; i++) {\n    if(authStore[i].equal(session)) {\n      found = true;\n      break;\n    }\n  }\n\n  if(!found) authStore.push(session);\n}\n\n/**\n * Re authenticate pool\n * @method\n * @param {{Server}|{ReplSet}|{Mongos}} server Topology the authentication method is being called on\n * @param {Pool} pool Connection pool for this topology\n * @param {authResultCallback} callback The callback to return the result from the authentication\n * @return {object}\n */\nGSSAPI.prototype.reauthenticate = function(server, pool, callback) {\n  var count = this.authStore.length;\n  if(count == 0) return callback(null, null);\n  // Iterate over all the auth details stored\n  for(var i = 0; i < this.authStore.length; i++) {\n    this.auth(server, pool, this.authStore[i].db, this.authStore[i].username, this.authStore[i].password, this.authStore[i].options, function(err, r) {\n      count = count - 1;\n      // Done re-authenticating\n      if(count == 0) {\n        callback(null, null);\n      }\n    });\n  }\n}\n\n/**\n * This is a result from a authentication strategy\n *\n * @callback authResultCallback\n * @param {error} error An error object. Set to null if no error present\n * @param {boolean} result The result of the authentication process\n */\n\nmodule.exports = GSSAPI;"]}