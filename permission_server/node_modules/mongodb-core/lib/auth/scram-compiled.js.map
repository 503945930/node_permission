{"version":3,"sources":["scram.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;AAEb,IAAI,CAAC,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM;IAC1B,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC;IAC1B,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM;IAC/B,UAAU,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;;AAErC,IAAI,WAAW,GAAG,SAAd,WAAW,CAAY,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE;AACjD,MAAI,CAAC,EAAE,GAAG,EAAE,CAAC;AACb,MAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;AACzB,MAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;CAC1B,CAAA;;AAED,WAAW,CAAC,SAAS,CAAC,KAAK,GAAG,UAAS,OAAO,EAAE;AAC9C,SAAO,OAAO,CAAC,EAAE,IAAI,IAAI,CAAC,EAAE,IACvB,OAAO,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,IACjC,OAAO,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,CAAC;CACxC,CAAA;;;;;;;AAOD,IAAI,SAAS,GAAG,SAAZ,SAAS,GAAc;AACzB,MAAI,CAAC,SAAS,GAAG,EAAE,CAAC;CACrB,CAAA;;AAED,IAAI,YAAY,GAAG,SAAf,YAAY,CAAY,OAAO,EAAE;AACnC,MAAI,IAAI,GAAG,EAAE,CAAC;AACd,MAAI,KAAK,GAAG,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;;AAE/B,OAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACpC,QAAI,UAAU,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;AACrC,QAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC;GACrC;;AAED,SAAO,IAAI,CAAC;CACb,CAAA;;AAED,IAAI,cAAc,GAAG,SAAjB,cAAc,CAAY,QAAQ,EAAE,QAAQ,EAAE;AAChD,MAAG,OAAO,QAAQ,IAAI,QAAQ,EAAE,MAAM,IAAI,UAAU,CAAC,2BAA2B,CAAC,CAAC;AAClF,MAAG,OAAO,QAAQ,IAAI,QAAQ,EAAE,MAAM,IAAI,UAAU,CAAC,2BAA2B,CAAC,CAAC;AAClF,MAAG,QAAQ,CAAC,MAAM,IAAI,CAAC,EAAE,MAAM,IAAI,UAAU,CAAC,0BAA0B,CAAC,CAAC;;AAE1E,MAAI,GAAG,GAAG,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;;AAEnC,KAAG,CAAC,MAAM,CAAC,QAAQ,GAAG,SAAS,GAAG,QAAQ,CAAC,CAAC;AAC5C,SAAO,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;CAC1B,CAAA;;;AAGD,IAAI,GAAG,GAAG,SAAN,GAAG,CAAY,CAAC,EAAE,CAAC,EAAE;AACvB,MAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,CAAC,GAAG,IAAI,MAAM,CAAC,CAAC,CAAC,CAAA;AAC1C,MAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,CAAC,GAAG,IAAI,MAAM,CAAC,CAAC,CAAC,CAAA;AAC1C,MAAI,GAAG,GAAG,EAAE,CAAA;AACZ,MAAI,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,MAAM,EAAE;AACvB,SAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACjC,SAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA;KACtB;GACF,MAAM;AACL,SAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACjC,SAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA;KACtB;GACF;AACD,SAAO,IAAI,MAAM,CAAC,GAAG,CAAC,CAAC;CACxB,CAAA;;;AAGD,IAAI,EAAE,GAAG,SAAL,EAAE,CAAY,IAAI,EAAE,IAAI,EAAE,UAAU,EAAE;;AAExC,MAAI,MAAM,GAAG,SAAT,MAAM,CAAY,GAAG,EAAE;AACzB,QAAI,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;AAC3C,QAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;AACjB,WAAO,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,QAAQ,CAAC,CAAC;GACpD,CAAA;;;AAGD,MAAI,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,IAAI,MAAM,CAAC,kBAAkB,CAAC,CAAC,CAAC,CAAA;AAC5D,MAAI,EAAE,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC;AACtB,MAAI,EAAE,GAAG,EAAE,CAAC;;AAEZ,OAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;AACtC,MAAE,GAAG,MAAM,CAAC,EAAE,CAAC,CAAC;AAChB,MAAE,GAAG,GAAG,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;GAClB;;AAED,SAAO,EAAE,CAAC;CACX,CAAA;;;;;;;;;;;;;AAaD,SAAS,CAAC,SAAS,CAAC,IAAI,GAAG,UAAS,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,QAAQ,EAAE;AAClF,MAAI,IAAI,GAAG,IAAI,CAAC;;AAEhB,MAAI,WAAW,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;;AAEhC,MAAI,KAAK,GAAG,WAAW,CAAC,MAAM,CAAC;AAC/B,MAAG,KAAK,IAAI,CAAC,EAAE,OAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;;;AAG3C,MAAI,wBAAwB,GAAG,CAAC,CAAC;AACjC,MAAI,gBAAgB,GAAG,KAAK,CAAC;AAC7B,MAAI,WAAW,GAAG,IAAI,CAAC;;;AAGvB,SAAM,WAAW,CAAC,MAAM,GAAG,CAAC,EAAE;;AAE5B,QAAI,YAAY,GAAG,SAAf,YAAY,CAAY,UAAU,EAAE;;AAEtC,cAAQ,GAAG,QAAQ,CAAC,OAAO,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC,OAAO,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;;;AAG5D,UAAI,KAAK,GAAG,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;;AAEtD,UAAI,SAAS,GAAG,CAAC,CAAC,WAAW,EAAE,QAAQ,EAAE,KAAK,CAAC,CAAC;;;AAGhD,UAAI,GAAG,GAAG;AACN,iBAAS,EAAE,CAAC;AACZ,iBAAS,EAAE,aAAa;AACxB,eAAO,EAAE,IAAI,MAAM,CAAC,CAAC,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC;AAC1C,qBAAa,EAAE,CAAC;OACnB,CAAA;;;AAGD,UAAI,WAAW,GAAG,SAAd,WAAW,CAAY,GAAG,EAAE,CAAC,EAAE;AACjC,YAAG,GAAG,EAAE;AACN,qBAAW,GAAG,GAAG,CAAC,AAAC,OAAO,KAAK,CAAC;SACjC,MAAM,IAAG,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE;AAC1B,qBAAW,GAAG,CAAC,CAAC,MAAM,CAAC,AAAC,OAAO,KAAK,CAAC;SACtC,MAAM,IAAG,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE;AAC5B,qBAAW,GAAG,CAAC,CAAC,MAAM,CAAC,AAAC,OAAO,KAAK,CAAC;SACtC,MAAM;AACL,0BAAgB,GAAG,IAAI,CAAC;AACxB,kCAAwB,GAAG,wBAAwB,GAAG,CAAC,CAAC;SACzD;;AAED,eAAO,IAAI,CAAA;OACZ,CAAA;;;AAGD,UAAI,MAAM,GAAG,SAAT,MAAM,CAAY,MAAM,EAAE,yBAAyB,EAAE;AACvD,YAAG,MAAM,IAAI,CAAC,IAAI,yBAAyB,GAAG,CAAC,EAAE;;AAE/C,wBAAc,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,WAAW,CAAC,EAAE,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC,CAAC;;AAExE,iBAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;SAC7B,MAAM,IAAG,MAAM,IAAI,CAAC,EAAE;AACrB,cAAG,WAAW,IAAI,IAAI,EAAE,WAAW,GAAG,IAAI,UAAU,CAAC,CAAC,CAAC,oCAAoC,CAAC,CAAC,CAAC;AAC9F,iBAAO,QAAQ,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;SACrC;OACF,CAAA;;AAED,UAAI,SAAS,GAAG,SAAZ,SAAS,CAAY,IAAI,EAAE,EAAE,EAAE;;AAEjC,mBAAW,CAAC,IAAI,EAAE,EAAE,CAAC,CAAA;;AAErB,aAAK,GAAG,KAAK,GAAG,CAAC,CAAC;;AAElB,cAAM,CAAC,KAAK,EAAE,wBAAwB,CAAC,CAAC;OACzC,CAAA;;;AAGD,YAAM,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,EAC3B,GAAG,EAAE,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;;;AAGpD,YAAG,WAAW,CAAC,GAAG,EAAE,CAAC,CAAC,IAAI,KAAK,EAAE;AAC/B,eAAK,GAAG,KAAK,GAAG,CAAC,CAAC;;AAElB,cAAG,KAAK,IAAI,CAAC,IAAI,wBAAwB,GAAG,CAAC,EAAE;;AAE7C,0BAAc,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,WAAW,CAAC,EAAE,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC,CAAC;;AAExE,mBAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;WAC7B,MAAM,IAAG,KAAK,IAAI,CAAC,EAAE;AACpB,gBAAG,WAAW,IAAI,IAAI,EAAE,WAAW,GAAG,IAAI,UAAU,CAAC,CAAC,CAAC,oCAAoC,CAAC,CAAC,CAAC;AAC9F,mBAAO,QAAQ,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;WACrC;;AAED,iBAAO;SACR;;;AAGD,YAAI,IAAI,GAAG,YAAY,CAAC,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,CAAA;;;AAGjD,YAAI,UAAU,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;AACtC,YAAI,IAAI,GAAG,IAAI,CAAC,CAAC,CAAC;AAClB,YAAI,MAAM,GAAG,IAAI,CAAC,CAAC,CAAC;;;AAGpB,YAAI,YAAY,GAAG,CAAC,CAAC,aAAa,EAAE,MAAM,CAAC,CAAC;AAC5C,YAAI,WAAW,GAAG,cAAc,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;AACrD,YAAI,cAAc,GAAG,EAAE,CAAC,WAAW,EAC7B,IAAI,MAAM,CAAC,IAAI,EAAE,QAAQ,CAAC,EAC1B,UAAU,CAAC,CAAC;;;AAGlB,YAAI,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;AACrD,YAAI,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC;AACtC,YAAI,SAAS,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,QAAQ,CAAC,CAAC;;;AAG5D,YAAI,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;AACrC,YAAI,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;AACvB,YAAI,SAAS,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,QAAQ,CAAC,CAAC;;;AAG5D,YAAI,OAAO,GAAG,CAAC,SAAS,EAAE,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,YAAY,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;;;AAG/F,YAAI,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;AAChD,YAAI,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC;AACjC,YAAI,SAAS,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,QAAQ,CAAC,CAAC;;;AAG5D,YAAI,WAAW,GAAG,CAAC,CAAC,MAAM,EAAE,IAAI,MAAM,CAAC,GAAG,CAAC,SAAS,EAAE,SAAS,CAAC,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;;;AAGtF,YAAI,WAAW,GAAG,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;;;AAGxD,YAAI,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;AACrD,YAAI,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,YAAY,CAAC,CAAC,CAAA;AACrC,YAAI,SAAS,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,QAAQ,CAAC,CAAC;;;AAG5D,YAAI,IAAI,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;AAChD,YAAI,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,CAAC,CAAA;AAChC,YAAI,SAAS,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,QAAQ,CAAC,CAAC;;;;AAI5D,YAAI,GAAG,GAAG;AACN,sBAAY,EAAE,CAAC;AACf,wBAAc,EAAE,CAAC,CAAC,MAAM,CAAC,cAAc;AACvC,iBAAO,EAAE,IAAI,MAAM,CAAC,IAAI,MAAM,CAAC,WAAW,CAAC,CAAC;SAC/C,CAAA;;;;AAID,cAAM,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,EAC3B,GAAG,EAAE,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;AAClD,cAAG,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,IAAI,IAAI,KAAK,EAAE;AAC9B,gBAAI,GAAG,GAAG;AACN,0BAAY,EAAE,CAAC;AACf,4BAAc,EAAE,CAAC,CAAC,MAAM,CAAC,cAAc;AACvC,qBAAO,EAAE,IAAI,MAAM,CAAC,CAAC,CAAC;aACzB,CAAA;;AAED,kBAAM,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,EAC3B,GAAG,EAAE,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;AAClD,uBAAS,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;aACrB,CAAC,CAAC;WACJ,MAAM;AACL,qBAAS,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;WACnB;SACJ,CAAC,CAAC;OACJ,CAAC,CAAC;KACJ,CAAA;;;AAGD,gBAAY,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC,CAAC;GACnC;CACF,CAAA;;;AAGD,IAAI,cAAc,GAAG,SAAjB,cAAc,CAAY,SAAS,EAAE,OAAO,EAAE;AAChD,MAAI,KAAK,GAAG,KAAK,CAAC;;AAElB,OAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACxC,QAAG,SAAS,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE;AAC9B,WAAK,GAAG,IAAI,CAAC;AACb,YAAM;KACP;GACF;;AAED,MAAG,CAAC,KAAK,EAAE,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;CACpC,CAAA;;;;;;;;;;AAUD,SAAS,CAAC,SAAS,CAAC,cAAc,GAAG,UAAS,MAAM,EAAE,IAAI,EAAE,QAAQ,EAAE;AACpE,MAAI,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;AAClC,MAAG,KAAK,IAAI,CAAC,EAAE,OAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;;AAE3C,OAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AAC7C,QAAI,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,UAAS,GAAG,EAAE,CAAC,EAAE;AACrH,WAAK,GAAG,KAAK,GAAG,CAAC,CAAC;;AAElB,UAAG,KAAK,IAAI,CAAC,EAAE;AACb,gBAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;OACtB;KACF,CAAC,CAAC;GACJ;CACF,CAAA;;AAGD,MAAM,CAAC,OAAO,GAAG,SAAS,CAAC","file":"scram-compiled.js","sourcesContent":["\"use strict\";\n\nvar f = require('util').format\n  , crypto = require('crypto')\n  , Binary = require('bson').Binary\n  , MongoError = require('../error');\n\nvar AuthSession = function(db, username, password) {\n  this.db = db;\n  this.username = username;\n  this.password = password;\n} \n\nAuthSession.prototype.equal = function(session) {\n  return session.db == this.db \n    && session.username == this.username\n    && session.password == this.password;\n}\n\n/**\n * Creates a new ScramSHA1 authentication mechanism\n * @class\n * @return {ScramSHA1} A cursor instance\n */\nvar ScramSHA1 = function() {\n  this.authStore = [];\n}\n\nvar parsePayload = function(payload) {\n  var dict = {};\n  var parts = payload.split(',');\n\n  for(var i = 0; i < parts.length; i++) {\n    var valueParts = parts[i].split('=');\n    dict[valueParts[0]] = valueParts[1];\n  }\n\n  return dict;\n}\n\nvar passwordDigest = function(username, password) {\n  if(typeof username != 'string') throw new MongoError(\"username must be a string\");\n  if(typeof password != 'string') throw new MongoError(\"password must be a string\");\n  if(password.length == 0) throw new MongoError(\"password cannot be empty\");\n  // Use node md5 generator\n  var md5 = crypto.createHash('md5');\n  // Generate keys used for authentication\n  md5.update(username + \":mongo:\" + password);\n  return md5.digest('hex');\n}\n\n// XOR two buffers\nvar xor = function(a, b) {\n  if (!Buffer.isBuffer(a)) a = new Buffer(a)\n  if (!Buffer.isBuffer(b)) b = new Buffer(b)\n  var res = []\n  if (a.length > b.length) {\n    for (var i = 0; i < b.length; i++) {\n      res.push(a[i] ^ b[i])\n    }\n  } else {\n    for (var i = 0; i < a.length; i++) {\n      res.push(a[i] ^ b[i])\n    }\n  }\n  return new Buffer(res);\n}\n\n// Create a final digest\nvar hi = function(data, salt, iterations) {\n  // Create digest\n  var digest = function(msg) {\n    var hmac = crypto.createHmac('sha1', data);\n    hmac.update(msg);\n    return new Buffer(hmac.digest('base64'), 'base64');\n  }\n\n  // Create variables\n  salt = Buffer.concat([salt, new Buffer('\\x00\\x00\\x00\\x01')])\n  var ui = digest(salt);\n  var u1 = ui;\n  \n  for(var i = 0; i < iterations - 1; i++) {\n    u1 = digest(u1);\n    ui = xor(ui, u1);\n  }\n\n  return ui;\n}\n\n/**\n * Authenticate\n * @method\n * @param {{Server}|{ReplSet}|{Mongos}} server Topology the authentication method is being called on\n * @param {Pool} pool Connection pool for this topology\n * @param {string} db Name of the database\n * @param {string} username Username\n * @param {string} password Password\n * @param {authResultCallback} callback The callback to return the result from the authentication\n * @return {object}\n */\nScramSHA1.prototype.auth = function(server, pool, db, username, password, callback) {\n  var self = this;\n  // Get all the connections\n  var connections = pool.getAll();\n  // Total connections\n  var count = connections.length;\n  if(count == 0) return callback(null, null);\n\n  // Valid connections\n  var numberOfValidConnections = 0;\n  var credentialsValid = false;\n  var errorObject = null;\n\n  // For each connection we need to authenticate\n  while(connections.length > 0) {    \n    // Execute MongoCR\n    var executeScram = function(connection) {\n      // Clean up the user\n      username = username.replace('=', \"=3D\").replace(',', '=2C');\n\n      // Create a random nonce\n      var nonce = crypto.randomBytes(24).toString('base64');\n      // var nonce = 'MsQUY9iw0T9fx2MUEz6LZPwGuhVvWAhc'\n      var firstBare = f(\"n=%s,r=%s\", username, nonce);\n\n      // Build command structure\n      var cmd = {\n          saslStart: 1\n        , mechanism: 'SCRAM-SHA-1'\n        , payload: new Binary(f(\"n,,%s\", firstBare))\n        , autoAuthorize: 1\n      }\n\n      // Handle the error\n      var handleError = function(err, r) {\n        if(err) {\n          errorObject = err; return false;\n        } else if(r.result['$err']) {\n          errorObject = r.result; return false;\n        } else if(r.result['errmsg']) {\n          errorObject = r.result; return false;\n        } else {\n          credentialsValid = true;\n          numberOfValidConnections = numberOfValidConnections + 1;            \n        }\n\n        return true\n      }\n\n      // Finish up\n      var finish = function(_count, _numberOfValidConnections) {\n        if(_count == 0 && _numberOfValidConnections > 0) {\n          // Store the auth details\n          addAuthSession(self.authStore, new AuthSession(db, username, password));\n          // Return correct authentication\n          return callback(null, true);\n        } else if(_count == 0) {\n          if(errorObject == null) errorObject = new MongoError(f(\"failed to authenticate using scram\"));\n          return callback(errorObject, false);\n        }\n      }\n\n      var handleEnd = function(_err, _r) {\n        // Handle any error\n        handleError(_err, _r)\n        // Adjust the number of connections\n        count = count - 1;\n        // Execute the finish\n        finish(count, numberOfValidConnections);                \n      }\n\n      // Execute start sasl command\n      server.command(f(\"%s.$cmd\", db)\n        , cmd, { connection: connection }, function(err, r) {\n        \n        // Do we have an error, handle it\n        if(handleError(err, r) == false) {\n          count = count - 1;\n\n          if(count == 0 && numberOfValidConnections > 0) {\n            // Store the auth details\n            addAuthSession(self.authStore, new AuthSession(db, username, password));\n            // Return correct authentication\n            return callback(null, true);\n          } else if(count == 0) {\n            if(errorObject == null) errorObject = new MongoError(f(\"failed to authenticate using scram\"));\n            return callback(errorObject, false);\n          }\n\n          return;\n        }\n\n        // Get the dictionary\n        var dict = parsePayload(r.result.payload.value())\n\n        // Unpack dictionary\n        var iterations = parseInt(dict.i, 10);\n        var salt = dict.s;\n        var rnonce = dict.r;\n\n        // Set up start of proof\n        var withoutProof = f(\"c=biws,r=%s\", rnonce);\n        var passwordDig = passwordDigest(username, password);\n        var saltedPassword = hi(passwordDig\n            , new Buffer(salt, 'base64')\n            , iterations);\n        \n        // Create the client key\n        var hmac = crypto.createHmac('sha1', saltedPassword);\n        hmac.update(new Buffer(\"Client Key\"));\n        var clientKey = new Buffer(hmac.digest('base64'), 'base64');\n\n        // Create the stored key\n        var hash = crypto.createHash('sha1');\n        hash.update(clientKey);\n        var storedKey = new Buffer(hash.digest('base64'), 'base64');\n\n        // Create the authentication message\n        var authMsg = [firstBare, r.result.payload.value().toString('base64'), withoutProof].join(',');\n\n        // Create client signature\n        var hmac = crypto.createHmac('sha1', storedKey);\n        hmac.update(new Buffer(authMsg));          \n        var clientSig = new Buffer(hmac.digest('base64'), 'base64');\n\n        // Create client proof\n        var clientProof = f(\"p=%s\", new Buffer(xor(clientKey, clientSig)).toString('base64'));\n\n        // Create client final\n        var clientFinal = [withoutProof, clientProof].join(',');\n\n        // Generate server key\n        var hmac = crypto.createHmac('sha1', saltedPassword);\n        hmac.update(new Buffer('Server Key'))\n        var serverKey = new Buffer(hmac.digest('base64'), 'base64');\n\n        // Generate server signature\n        var hmac = crypto.createHmac('sha1', serverKey);\n        hmac.update(new Buffer(authMsg))\n        var serverSig = new Buffer(hmac.digest('base64'), 'base64');\n\n        //\n        // Create continue message\n        var cmd = {\n            saslContinue: 1\n          , conversationId: r.result.conversationId\n          , payload: new Binary(new Buffer(clientFinal))\n        }\n\n        //\n        // Execute sasl continue\n        server.command(f(\"%s.$cmd\", db)\n          , cmd, { connection: connection }, function(err, r) {\n            if(r && r.result.done == false) {\n              var cmd = {\n                  saslContinue: 1\n                , conversationId: r.result.conversationId\n                , payload: new Buffer(0)\n              }\n\n              server.command(f(\"%s.$cmd\", db)\n                , cmd, { connection: connection }, function(err, r) {\n                  handleEnd(err, r);\n              });\n            } else {\n              handleEnd(err, r);\n            }\n        });\n      });\n    }\n\n    // Get the connection\n    executeScram(connections.shift());\n  }\n}\n\n// Add to store only if it does not exist\nvar addAuthSession = function(authStore, session) {\n  var found = false;\n\n  for(var i = 0; i < authStore.length; i++) {\n    if(authStore[i].equal(session)) {\n      found = true;\n      break;\n    }\n  }\n\n  if(!found) authStore.push(session);\n}\n\n/**\n * Re authenticate pool\n * @method\n * @param {{Server}|{ReplSet}|{Mongos}} server Topology the authentication method is being called on\n * @param {Pool} pool Connection pool for this topology\n * @param {authResultCallback} callback The callback to return the result from the authentication\n * @return {object}\n */\nScramSHA1.prototype.reauthenticate = function(server, pool, callback) {\n  var count = this.authStore.length;\n  if(count == 0) return callback(null, null);\n  // Iterate over all the auth details stored\n  for(var i = 0; i < this.authStore.length; i++) {\n    this.auth(server, pool, this.authStore[i].db, this.authStore[i].username, this.authStore[i].password, function(err, r) {\n      count = count - 1;\n      // Done re-authenticating\n      if(count == 0) {\n        callback(null, null);\n      }\n    });\n  }\n}\n\n\nmodule.exports = ScramSHA1;"]}