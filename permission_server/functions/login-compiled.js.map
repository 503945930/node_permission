{"version":3,"sources":["login.js"],"names":[],"mappings":"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","file":"login-compiled.js","sourcesContent":["/**\r\n * Created by Administrator on 2015/9/13 0013.\r\n */\r\n/**\r\n * Created by Administrator on 2015/9/6 0006.\r\n */\r\nvar crypto = require('crypto'),\r\n    func = require('node-odata').Function,\r\n    resources = require('node-odata').resources,\r\n    co = require('co');\r\nrouter = func();\r\n\r\n//注册回调\r\nrouter.post('/login', function (req, res, next) {\r\n    // console.log(req.body);\r\n    var account, pwd;\r\n    account = req.body.account;\r\n    pwd = req.body.password;\r\n    console.log(account);\r\n    co(function *() {\r\n      var  user = yield resources.users.findOne({\r\n            \"password\": pwd\r\n        }).or([{\r\n            \"account\": account\r\n        }, {\r\n            \"email\": account\r\n        }]);\r\n        console.log(user);\r\n        user.token = crypto.createHash(\"md5\").update(new Date() + pwd).digest(\"hex\");\r\n        user.save();\r\n        return user;\r\n\r\n    }).then(function(user){\r\n        res.set(\"authorization\", user.token);\r\n        res.json({\r\n            account: user.account,\r\n            password: user.password,\r\n            email: user.email,\r\n            permission:user.permission,\r\n            states:user.states\r\n        });\r\n    }).catch(function(err){\r\n        console.log(err);\r\n        return res.status(401).send(\"fail to login\");\r\n    })\r\n\r\n\r\n});\r\n\r\nrouter.post('/auto-login', function (req, res, next) {\r\n    if (!req.user) {\r\n        return res.status(401).send(\"fail to auto-login\");\r\n    }\r\n    return res.json({\r\n        name: req.user.name,\r\n        loginName: req.user.loginName,\r\n        email: req.user.email,\r\n        gravatar: req.user.gravatar,\r\n        disabled: req.user.disabled\r\n    });\r\n});\r\n\r\nrouter.post('/logoff', function (req, res, next) {\r\n    var token;\r\n    token = req.get(\"authorization\");\r\n    return resources.admins.findOne({\r\n        token: token\r\n    }).exec(function (err, user) {\r\n        if (!user) {\r\n            return res.status(400).send(\"User not found.\");\r\n        }\r\n        user.token = null;\r\n        user.save();\r\n        return res.json({\r\n            name: user.name,\r\n            loginName: user.loginName,\r\n            email: user.email,\r\n            gravatar: user.gravatar,\r\n            disabled: user.disabled\r\n        });\r\n    });\r\n});\r\n\r\nmodule.exports = router;\r\n"]}